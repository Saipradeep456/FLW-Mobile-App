name: Build and Distribute to Firebase

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      environment:
        required: true
        type: string
      variant:
        required: true
        type: string
      build_type:
        required: true
        type: string
      version:
        required: true
        type: string

    secrets:
      GOOGLE_SERVICES_JSON_GENERIC:
        required: true
      FIREBASE_CREDENTIALS_JSON:
        required: true
      GOOGLE_PLAY_JSON_KEY:
        required: true
      KEYSTORE_FILE:
        required: true
      KEYSTORE_PASSWORD:
        required: true
      KEY_ALIAS:
        required: true
      KEY_PASSWORD:
        required: true
      BASE_TMC_URL:
        required: true
      BASE_AMRIT_URL:
        required: true
      BASE_FLW_URL:
        required: true
      BASE_ABHA_URL:
        required: true
      SANJEEVANI_API_URL:
        required: true
      FIREBASE_APP_ID:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Cache NDK
        uses: actions/cache@v4
        with:
          path: /usr/local/lib/android/sdk/ndk
          key: ubuntu-latest-ndk-r29

      - name: Cache CMake
        uses: actions/cache@v4
        with:
          path: ~/.cmake
          key: ubuntu-latest-cmake-3.31.1

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1.5.0
        with:
          ndk-version: r29
          link-to-sdk: true

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.31.1'

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.4
          bundler-cache: true

      - name: Verify Ruby
        run: ruby -v

      - name: Decode google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_GENERIC }}" | base64 --decode > app/google-services.json

      - name: Decode Firebase credentials
        run: |
          echo "${{ secrets.FIREBASE_CREDENTIALS_JSON }}" | base64 --decode > firebase_credentials.json

      - name: Decode Google Play key
        run: |
          echo "${{ secrets.GOOGLE_PLAY_JSON_KEY }}" | base64 --decode > fastlane/google_play_service_account.json

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > keystore.jks

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Set version
        run: echo "version=${{ inputs.version }}" >> $GITHUB_ENV

      - name: Verify version
        run: |
          if [ -z "$version" ]; then
            echo "Version not set"
            exit 1
          fi
          echo "Version: $version"

      - name: Build and Distribute to Firebase
        run: |
          export BASE_TMC_URL="${{ secrets.BASE_TMC_URL }}"
          export BASE_AMRIT_URL="${{ secrets.BASE_AMRIT_URL }}"
          export BASE_FLW_URL="${{ secrets.BASE_FLW_URL }}"
          export BASE_ABHA_URL="${{ secrets.BASE_ABHA_URL }}"
          export SANJEEVANI_API_URL="${{ secrets.SANJEEVANI_API_URL }}"

          export KEYSTORE_PATH="$PWD/keystore.jks"
          export KEYSTORE_PASSWORD="${{ secrets.KEYSTORE_PASSWORD }}"
          export KEY_ALIAS="${{ secrets.KEY_ALIAS }}"
          export KEY_PASSWORD="${{ secrets.KEY_PASSWORD }}"

          export FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}"

          if [ "${{ inputs.build_type }}" = "debug" ]; then
            bundle exec fastlane build_and_distribute_debug variant:${{ inputs.variant }}
          else
            bundle exec fastlane build_and_distribute_release variant:${{ inputs.variant }}
          fi
